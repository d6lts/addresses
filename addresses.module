<?php
/**
 * $Id$
 * @author Bruno Massa
 * @file addresses.module
 * You can associate a geographic address with content and users.
 */

define('ADDRESSES_PATH' , drupal_get_path('module', 'addresses'));

/**
 * The address fields can be: displayed, required, hidden or not
 * used at all
 */
define('ADDRESSES_FIELD_NONE',      0);
define('ADDRESSES_FIELD_SHOW',      1);
define('ADDRESSES_FIELD_REQUIRED',  2);
define('ADDRESSES_FIELD_HIDDEN',    3);


/**
 * Load the full address from a given Address ID or User ID
 *
 * @param $id
 *   Number. The ID to look into the table. Depends on $type variable:
 *   if it is 'address' (default), it should look for a unique address
 *   ID, on 'aid' column. For anything else, search on 'eid' column.
 * @param $type
 *   String (optional). It can be:
 *   - 'address' (default): than search for a unique Address ID
 *   - 'user': get all address from a user
 *   - 'node: get all address from a node
 * @return
 *   Array. The numeric list of addresses arrays
 */
function _addresses_address_get($id, $type = 'address') {
  static $addresses;

  if (empty($addresses[$type][$id])) {
    // Get the address based on Address ID or
    // the (User/Node) ID and the given identification
    if ($type == 'address') {
      $adr = db_query('SELECT * FROM {addresses} WHERE aid = %d', $id);
    }
    else {
      $adr = db_query("SELECT * FROM {addresses}
        WHERE atype = '%s' AND eid = %d
        ORDER BY is_primary DESC", $type, $id);
    }

    // Transform all SQL findings into arrays
    $addresses[$type][$id] = array();
    while ($address = db_fetch_array($adr)) {
      $addresses[$type][$id][] = $address;
    }
  }

  return $addresses[$type][$id];
}

/**
 * Implementation of hook_menu().
 */
function addresses_menu() {
  $items['admin/settings/address'] = array(
    'description'     => t('Settings for Address module'),
    'file'            => 'addresses.inc',
    'page callback'   => 'drupal_get_form',
    'page arguments'  => array('_addresses_admin'),
    'title'           => t('Addresses'),
  );

  /// @todo use the correct ACCESS PERMISSION
  $items['admin/settings/address/autocomplete'] = array(
    'access'          => TRUE,
    'file'            => 'addresses.inc',
    'page callback'   => '_addresses_autocomplete',
    'type'            => MENU_CALLBACK
  );

  return $items;
}

/**
 * Implementation of hook_theme().
 */
function addresses_theme() {
  return array(
    'addresses' => array(
      'arguments' => array('address', 'hide'),
      'file'      => 'addresses.inc',
    ),
    'addresses_form' => array(
      'arguments' => array('form'),
      'file'      => 'addresses.inc',
    ),
    'addresses_address_singleline' => array(
      'arguments' => array('addresses'),
      'file'      => 'addresses.inc',
    ),
  );
}
